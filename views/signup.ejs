<% include partials/header.ejs %>
<script>
    $(document).ready(function() {
        //TODO - create a module and expose it as an API
        var formLockDownModule = (function() {

        }());

        var self = this;
        this.formErrors = 0;
        var inputFields = {
            $inputTextEmail: $("input[name = 'email']")
        }
        this.errorTexts = {
            emailErrorText: $('#error-invalid-email')
        }
        this.regexCollection = {
             emailRegex: /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
        }

        this.increaseErrors = function() {
            this.formErrors++;
        }

        this.getNumberOfErrors = function () {
            return this.formErrors;
        }

        this.disableSubmitButton = function() {
            $("button[type='submit']").prop('disabled', true).text('Exista erori in formularul de inscriere!').attr('class', 'btn btn-danger btn-lg');
        }

        this.enableSubmitButton = function () {
            $("button[type='submit']").prop('disabled', false).text('Signup').attr('class', 'btn btn-success btn-lg');
        }

        this.checkInputForErrors = function(inputField, regex, errorTextParagraph, cb) {
            var isWithoutErrors = false;
            if( !regex.test(inputField.val()) && inputField.val().length > 0) {
                errorTextParagraph.css({'display': 'block'});
            } else {
                isWithoutErrors = true;
                errorTextParagraph.css({'display': 'none'});
            }

            cb(isWithoutErrors);
        }

        this.formLockDown = function () {
            this.increaseErrors();
            this.getNumberOfErrors();
            this.disableSubmitButton();
        }

        //TODO - keydown sau blur
        inputFields.$inputTextEmail.on('keydown', function() {
            self.checkInputForErrors(inputFields.$inputTextEmail, self.regexCollection.emailRegex, self.errorTexts.emailErrorText, function(isWithoutErrors) {
                if(!isWithoutErrors) {
                    self.formLockDown();
                } else {
                    self.enableSubmitButton();
                }
            });
        });

       $battleNetIdField = $('.battlenetId');
       $battleNetIdField.on('focus', function() {
           console.log('Battle Net Id Field has focus');
           //TODO - create ajax request to battlenet api and block UI until response comes back
       });
    });
</script>
<div class="container">
    <div class="col-sm-6 col-sm-offset-3">
        <h1><span class="fa fa-sign-in"></span> Signup</h1>
        <!-- LOGIN FORM -->
        <form action="/signup" method="post">
            <div class="form-group">
                <% for(var i in messages) { %>
                    <div class="alert alert-danger" role="alert"><%= messages[i] %></div>
                <% } %>
                <label>Email</label>
                <!-- show any messages that come back with authentication -->
                <!-- TODO - place all fields that are appearing if there are errors inside the if(messages.length > 0)-->
                <!-- TODO - place all fields that are appearing by default when user navigates to signup page in the else clause-->
                <% if ( messages.length > 0 ) {%>
                    <input style="color: #66CD00" type="text" class="form-control" name="email" value="<%=previousFormValues.userEmail%>" required>
                <%}else { %>
                    <input type="text" class="form-control" name="email" required placeholder="Introdu un email valid" />
                    <!-- required for JQuery validation-->
                <div id="error-invalid-email" class="error-message-container" style="background-color: #f05a5c; display:none; width: 100%;
                       height: 50px; color: white; border-radius: 5px; margin-top: 15px;
                       text-align: left; padding-top: 15px; padding-left: 10px; font-style: italic; position: relative;">
                    <div style="width: 20px; height: 20px; margin-left: auto; margin-right: auto;
                        background-color: #f05a5c;
                        position: absolute;
                        left: 270px;
                        top: -5px;
                        transform: rotate(45deg);
                        -ms-transform:rotate(45deg); /* IE9 */
	                    -moz-transform: rotate(45deg);  /* FF3.5/3.6 */
	                    -o-transform: rotate(45deg);  /* Opera 10.5 */
	                    -webkit-transform: rotate(45deg);  /* Saf3.1+ */
                        "></div>
                    <p>ERREMADDR - Acest tip de email nu exista in sectorul Koprulu! Esti zerg?</p>
                </div>
                <%}%>
            </div>
            <div class="form-group">
                <label>Parola</label>
                <input type="password" class="form-control" name="password" required placeholder="Parolele trebuie sa se potriveasca">
            </div>
            <div class="form-group">
                <label>Parola din nou</label>
                <input type="password" class="form-control" name="PasswordAgain" required placeholder="Parolele trebuie sa se potriveasca">
            </div>
            <div class="form-group">
                <label>Nickname</label>
                <% if ( messages.length > 0 ) {%>
                    <input style="color: #66CD00" type="text" class="form-control" name="nickname" value="<%=previousFormValues.userNickname%>" required>
                <%} else { %>
                    <input type="text" class="form-control" name="nickname" required placeholder="Minim 3 caractere, maxim 30 caractere">
                <%}%>
            </div>
            <div class="form-group">
                <label>Doresc un cont de</label>
                <%if(messages.length > 0) {%>
                    <% var filteredRoles = pageElements.filteredRoles(previousFormValues.userAccount) %>
                    <select style="border:1px solid #66CD00" class="form-control" name="role" required>
                        <optgroup label="Ai ales urmatorul tip de cont: ">
                            <option value="<%= previousFormValues.userAccount%>"><%= previousFormValues.userAccount %></option>
                        </optgroup>
                        <optgroup label="Alte tipuri de conturi: ">
                            <%for(var i = 0; i < filteredRoles.length; i++){%>
                                <option value="<%= filteredRoles[i]%>"><%= filteredRoles[i] %></option>
                            <%}%>
                        </optgroup>
                    </select>
                <%} else {%>
                    <select class="form-control" name="role" required>
                        <%for(var i = 0; i < pageElements.roles.length; i++){%>
                            <option value="<%= pageElements.roles[i]%>"><%= pageElements.roles[i]%></option>
                        <%}%>
                    </select>
                <%}%>
            </div>
            <div class="form-group">
                <label>Battle.net ID (fara #)</label>
                <%if(messages.length > 0) {%>
                    <input style="color: #66CD00" type="text" class="form-control battlenetId" name="battlenetid" value="<%=previousFormValues.userBNetId%>" required>
                <%} else {%>
                    <input type="text" class="form-control battlenetId" name="battlenetid" required placeholder="Introdu un cod de BattlenetID valid, fara #">
                <%}%>
            </div>
            <div class="form-group">
                <label>Rasa cu care joci</label>
                <%if(messages.length > 0) {%>
                    <%var filteredRaces = pageElements.filteredRaces(previousFormValues.userRace)%>
                <select style="border:1px solid #66CD00" class="form-control" name="race" required>
                    <optgroup label="Ai ales urmatoarea rasa: ">
                        <option value="<%= previousFormValues.userRace%>"><%= previousFormValues.userRace%></option>
                    </optgroup>
                    <optgroup label="Alte rase disponibile: ">
                        <% for (var i = 0; i < filteredRaces.length; i++){%>
                            <option value="<%= filteredRaces[i]%>"><%= filteredRaces[i]%></option>
                        <%}%>
                    </optgroup>
                </select>
                <%} else {%>
                <select class="form-control" name="race" required>
                    <% for (var i = 0; i < pageElements.races.length; i++){%>
                        <option value="<%= pageElements.races[i]%>"><%= pageElements.races[i]%></option>
                    <%}%>
                </select>
                <%}%>
            </div>
            <div class="form-group">
                <label>Liga din care faci parte</label>
                <%if(messages.length > 0){%>
                    <%var filteredLeagues = pageElements.filteredLeagues(previousFormValues.userLeague)%>
                    <select style="border:1px solid #66CD00" class="form-control" name="league" required>
                        <optgroup label="Ai ales urmatoarea liga: ">
                            <option value="<%=previousFormValues.userLeague%>"><%=previousFormValues.userLeague%></option>
                        </optgroup>
                        <optgroup label="Alte ligi disponibile">
                            <%for (var i = 0; i < filteredLeagues.length; i++){%>
                                <option value="<%= filteredLeagues[i]%>"><%= filteredLeagues[i]%></option>
                            <%}%>
                        </optgroup>
                    </select>
                <%} else {%>
                    <select class="form-control" name="league" required>
                        <%for (var i = 0; i < pageElements.leagues.length; i++){%>
                            <option value="<%= pageElements.leagues[i]%>"><%= pageElements.leagues[i]%></option>
                        <%}%>
                    </select>
                <%}%>
            </div>
            <input type="hidden" value="5425982be4b0b7147c91e951" name="defaultAvatar"/>

            <button type="submit" class="btn btn-success btn-lg">Signup</button>
        </form>
        <hr>
        <p>Ai deja un cont? <a href="/login">Login</a></p>
        <p>Sau mergi la <a href="/">pagina principala</a>.</p>
    </div>
</div>

<% include partials/footer.ejs %>